var DATA_PLAYER_CHARACTERS =
[
    {"characterID":0x0F, "spriteID":0x10, "paletteID":0x05, "sleepingID":0x06, "id":2, "name":"Avatar", "tags":["base", "realistic"]},
    {"characterID":0x0F, "spriteID":0x10, "paletteID":0x02, "sleepingID":0x06, "id":3, "name":"Avatar Dark", "tags":["realistic"]},
    {"characterID":0x0B, "spriteID":0x0C, "paletteID":0x01, "sleepingID":0x06, "id":4, "name":"Bard", "tags":["base", "realistic"]},
    {"characterID":0x0B, "spriteID":0x0C, "paletteID":0x06, "sleepingID":0x06, "id":5, "name":"Bard (Blue)", "tags":["realistic"]},
    {"characterID":0x06, "spriteID":0x07, "paletteID":0x03, "sleepingID":0x05, "id":6, "name":"Child", "tags":["base", "realistic"]},
    {"characterID":0x06, "spriteID":0x07, "paletteID":0x01, "sleepingID":0x03, "id":7, "name":"Child (Pink)", "tags":["wild"]},
    {"characterID":0x29, "spriteID":0x22, "paletteID":0x00, "sleepingID":0x01, "id":8, "name":"Daemon (Brown)", "tags":["monster"]},
    {"characterID":0x29, "spriteID":0x22, "paletteID":0x04, "sleepingID":0x01, "id":9, "name":"Daemon (Green)", "tags":["monster"]},
    {"characterID":0x29, "spriteID":0x22, "paletteID":0x02, "sleepingID":0x01, "id":10, "name":"Daemon (Red)", "tags":["base", "monster"]},
    {"characterID":0x0C, "spriteID":0x0D, "paletteID":0x06, "sleepingID":0x02, "id":11, "name":"Dress Wearer (Blue)", "tags":["base", "realistic"]},
    {"characterID":0x0C, "spriteID":0x0D, "paletteID":0x02, "sleepingID":0x02, "id":12, "name":"Dress Wearer (Red)", "tags":["realistic"]},
    {"characterID":0x0A, "spriteID":0x0B, "paletteID":0x03, "sleepingID":0x05, "id":13, "name":"Farmer", "tags":["base", "realistic"]},
    {"characterID":0x01, "spriteID":0x02, "paletteID":0x05, "sleepingID":0x00, "id":14, "name":"Fighter (Silver)", "tags":["base", "realistic"]},
    {"characterID":0x01, "spriteID":0x02, "paletteID":0x00, "sleepingID":0x00, "id":15, "name":"Fighter (Bronze)", "tags":["realistic"]},
    {"characterID":0x26, "spriteID":0x21, "paletteID":0x04, "sleepingID":0x01, "id":16, "name":"Gargoyle (Green)", "tags":["wild"]},
    {"characterID":0x26, "spriteID":0x21, "paletteID":0x02, "sleepingID":0x01, "id":17, "name":"Gargoyle (Red)", "tags":["base"]},
    {"characterID":0x26, "spriteID":0x21, "paletteID":0x00, "sleepingID":0x01, "id":18, "name":"Gargoyle (Tan)", "tags":["wild"]},
    {"characterID":0x07, "spriteID":0x08, "paletteID":0x05, "sleepingID":0x00, "id":19, "name":"Guard", "tags":["base", "realistic"]},
    {"characterID":0x08, "spriteID":0x09, "paletteID":0x06, "sleepingID":0x04, "id":20, "name":"Jester", "tags":["base", "realistic"]},
    {"characterID":0x0E, "spriteID":0x0F, "paletteID":0x01, "sleepingID":0x02, "id":21, "name":"Lord British", "tags":["base"]},
    {"characterID":0x03, "spriteID":0x04, "paletteID":0x06, "sleepingID":0x02, "id":22, "name":"Mage (Blue)", "tags":["base", "realistic"]},
    {"characterID":0x03, "spriteID":0x04, "paletteID":0x02, "sleepingID":0x02, "id":23, "name":"Mage (Red)", "tags":["realistic"]},
    {"characterID":0x03, "spriteID":0x04, "paletteID":0x00, "sleepingID":0x02, "id":24, "name":"Mage (Tan)", "tags":["realistic"]},
    {"characterID":0x05, "spriteID":0x06, "paletteID":0x03, "sleepingID":0x05, "id":25, "name":"Merchant", "tags":["base", "realistic"]},
    {"characterID":0x2E, "spriteID":0x26, "paletteID":0x03, "sleepingID":0x04, "id":26, "name":"Mongbat", "tags":["base", "monster"]},
    {"characterID":0x04, "spriteID":0x05, "paletteID":0x01, "sleepingID":0x03, "id":27, "name":"Noble", "tags":["base", "realistic"]},
    {"characterID":0x09, "spriteID":0x0A, "paletteID":0x03, "sleepingID":0x04, "id":28, "name":"Peasant", "tags":["base", "realistic"]},
    {"characterID":0x09, "spriteID":0x0A, "paletteID":0x06, "sleepingID":0x04, "id":29, "name":"Peasant (Blue)", "tags":["realistic"]},
    {"characterID":0x09, "spriteID":0x0A, "paletteID":0x00, "sleepingID":0x04, "id":30, "name":"Peasant (Tan)", "tags":["realistic"]},
    {"characterID":0x02, "spriteID":0x03, "paletteID":0x05, "sleepingID":0x01, "id":31, "name":"Ranger", "tags":["base", "realistic"]},
    {"characterID":0x02, "spriteID":0x03, "paletteID":0x02, "sleepingID":0x01, "id":32, "name":"Ranger (Dark)", "tags":["realistic"]},
    {"characterID":0x2A, "spriteID":0x23, "paletteID":0x02, "sleepingID":0x02, "id":33, "name":"Skeleton", "tags":["base", "monster"]},
    {"characterID":0x2D, "spriteID":0x25, "paletteID":0x03, "sleepingID":0x05, "id":34, "name":"Troll", "tags":["base", "monster"]},
    {"characterID":0x2D, "spriteID":0x25, "paletteID":0x01, "sleepingID":0x03, "id":35, "name":"Troll (Pink)", "tags":["wild", "monster"]},
    {"characterID":0x0F, "spriteID":0xC0, "paletteID":0x00, "sleepingID":0x07, "id":36, "name":"U3 Skeleton", "tags":["wild", "custom"]},
    {"characterID":0x0F, "spriteID":0xC1, "paletteID":0x00, "sleepingID":0x07, "id":37, "name":"Spider", "tags":["wild", "custom"]},
    {"characterID":0x0F, "spriteID":0xC2, "paletteID":0x00, "sleepingID":0x07, "id":38, "name":"Skiff", "tags":["wild", "custom"]},
    {"characterID":0x0F, "spriteID":0xC3, "paletteID":0x05, "sleepingID":0x07, "id":39, "name":"U4 Mariah", "tags":["wild", "custom"]},
    {"characterID":0x0F, "spriteID":0xC4, "paletteID":0x00, "sleepingID":0x07, "id":40, "name":"Chest", "tags":["wild", "custom"]},
    {"characterID":0x0F, "spriteID":0xC5, "paletteID":0x00, "sleepingID":0x07, "id":41, "name":"Z1 Link", "tags":["wild", "custom"]},
    {"characterID":0x0F, "spriteID":0xC6, "paletteID":0x00, "sleepingID":0x07, "id":42, "name":"Z2 Fairy", "tags":["wild", "custom"]},
    {"characterID":0x0F, "spriteID":0xC7, "paletteID":0x00, "sleepingID":0x07, "id":43, "name":"SMW Boo", "tags":["wild", "custom"]},
    {"characterID":0x0F, "spriteID":0xC8, "paletteID":0x00, "sleepingID":0x07, "id":44, "name":"U6 Ghost", "tags":["wild", "custom"]},
    {"characterID":0x0F, "spriteID":0xC9, "paletteID":0x00, "sleepingID":0x07, "id":45, "name":"U6 Rabbit", "tags":["wild", "custom"]},
	{"characterID":0x0F, "spriteID":0xCA, "paletteID":0x05, "sleepingID":0x07, "id":46, "name":"FF3 Devout", "tags":["wild","custom"]},
];

function getCharacterNameByOptionID(inID)
{
    for(var i = 0; i < DATA_PLAYER_CHARACTERS.length; ++i)
    {
        if(inID == DATA_PLAYER_CHARACTERS[i].id)
        {
            return DATA_PLAYER_CHARACTERS[i].name;
        }
    }
    if(inID == 0){ return "Random (All)";}
    if(inID == 1){ return "Random (Realistic People Only)";}
    return DATA_PLAYER_CHARACTERS[0].name; //return avatar if no character found
}

function getCharacterIDByOptionID(inID)
{
    for(var i = 0; i < DATA_PLAYER_CHARACTERS.length; ++i)
    {
        if(inID == DATA_PLAYER_CHARACTERS[i].id)
        {
            return DATA_PLAYER_CHARACTERS[i];
        }
    }
    console.log("SELECTED CHARACTER NOT FOUND - DEFAULTING TO AVATAR");
    return DATA_PLAYER_CHARACTERS[0]; //return avatar if no character found
}

function getRandomCharacterWithTag(inTag)
{
    var characterList = [];
    for(var i = 0; i < DATA_PLAYER_CHARACTERS.length; ++i)
    {
        if(inTag != "")
        {
            if(DATA_PLAYER_CHARACTERS[i].tags.length > 0)
            {
                for(var j = 0; j < DATA_PLAYER_CHARACTERS[i].tags.length; ++j)
                {
                    if(inTag == DATA_PLAYER_CHARACTERS[i].tags[j])
                    {
                        characterList.push(DATA_PLAYER_CHARACTERS[i]);
                        break;
                    }
                }
            }
        }
        else
        {
            characterList.push(DATA_PLAYER_CHARACTERS[i])
        }
    }
    return characterList;
}

function setCharacterSprite(buffer, seed, character_sprite, fire_flag, ghost_flag)
{
	var rom = new Uint8Array(buffer);
    
    //default values = avatar
	var selectedCharacterHex = 0x0F;
	var selectedSpriteHex = 0x10;
    var selectedPaletteHex = 0x05;
    var selectedSleepingHex = 0x06;

	var spriteAddress = 0x16744; //0x16744 is Avatar sprite
    var paletteAddress = 0xF168; //0xF168 is Avatar palette
    var sleepingSpriteAddress = 0xF122; //0xF122 is Avatar sleeping sprite

    //random sprites
	if(character_sprite == 0) //random any sprite
	{
        var characterOptions = getRandomCharacterWithTag("");
        characterOptions.shuffle();
        selectedCharacterHex = characterOptions[0].characterID;
        selectedSpriteHex = characterOptions[0].spriteID;
        selectedPaletteHex = characterOptions[0].paletteID;
        selectedSleepingHex = characterOptions[0].sleepingID;
    }
    else if(character_sprite == 1) //random realistic person sprite
	{
        var characterOptions = getRandomCharacterWithTag("realistic");
        characterOptions.shuffle();
        selectedCharacterHex = characterOptions[0].characterID;
        selectedSpriteHex = characterOptions[0].spriteID;
        selectedPaletteHex = characterOptions[0].paletteID;
        selectedSleepingHex = characterOptions[0].sleepingID;
    }
    else
    {
        var selectedData = getCharacterIDByOptionID(character_sprite);
        selectedCharacterHex = selectedData.characterID;
        selectedSpriteHex = selectedData.spriteID;
        selectedPaletteHex = selectedData.paletteID;
        selectedSleepingHex = selectedData.sleepingID;
    }

    if(selectedSpriteHex >= 0xC0)
    {
        selectedSpriteHex = 0x10;
        var customSprite = setCustomSprite(rom, selectedData.spriteID);
        if(customSprite != null)
        {
            selectedPaletteHex = customSprite.paletteNumber;
        }
    } 
	else 
	{
		// write default data back in case a custom sprite has altered it
		console.log("WRITING DEFAULT SPRITE DATA BACK");
        rom.set(DATA_DEFAULT_CHARACTER.spriteData, 0x7C800);
		rom.set(DATA_DEFAULT_CHARACTER.sleepingData1, 0xEE5C0);
		rom.set(DATA_DEFAULT_CHARACTER.sleepingData2, 0xEE7C0);
        rom.set(DATA_DEFAULT_CHARACTER.invisData, 0xFE000);
	}

    rom[spriteAddress] = selectedSpriteHex;
    rom[sleepingSpriteAddress] = selectedSleepingHex;
    
    if(fire_flag > 0x00)
    {
        rom[paletteAddress] = 0x07;
    }
    else
    {
        rom[paletteAddress] = selectedPaletteHex;
    }

    if(ghost_flag > 0x00)
    {
        setDeadGhostSprites(rom);
    }

    fixChecksum(rom);
	return rom;
}

function setCustomSprite(rom, inSpriteID)
{
    var customSprite = null;
    for(var i = 0; i < DATA_CUSTOM_CHARACTERS.length; ++i)
    {
        if(DATA_CUSTOM_CHARACTERS[i].spriteID == inSpriteID)
        {
            customSprite = DATA_CUSTOM_CHARACTERS[i];
            break;
        }
    }
    if(customSprite == null)
    {
        consoleLog("SETTING CUSTOM SPRITE FAILED");
        return null;
    }

    consoleLog("SETTING CUSTOM SPRITE : " + customSprite.name);
    rom.set(customSprite.spriteData, 0x7C800);
    if(customSprite.sleepingData1.length > 1)
    {
        rom.set(customSprite.sleepingData1, 0xEE5C0);
        rom.set(customSprite.sleepingData2, 0xEE7C0);
    } else {
		rom.set(DATA_DEFAULT_CHARACTER.sleepingData1, 0xEE5C0);
		rom.set(DATA_DEFAULT_CHARACTER.sleepingData2, 0xEE7C0);
	}
    if(customSprite.invisData.length > 1)
    {
        rom.set(customSprite.invisData, 0xFE000);
    } else {
        rom.set(DATA_DEFAULT_CHARACTER.invisData, 0xFE000);
	}
    return customSprite;
}

function setDeadGhostSprites(rom)
{
    var s1 = [0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x06,0x4F,0x49,0xF5,0xB0,0x5F,0x50,0xBF,0xA8,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x06,0x4F,0x4F,0xF5,0xF5,0x5F,0x5F,0xBF,0xBF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x10,0xE8,0xE8,0xF0,0x10,0xE8,0xA8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x10,0xE8,0xE8,0xF0,0xF0,0xE8,0xE8,0x00,0x00,0x00,0x00,0x00,0x00,0x46,0x46,0xEF,0xA9,0xB5,0xB1,0x7F,0x50,0xAF,0xA9,0x00,0x00,0x00,0x00,0x00,0x00,0x46,0x46,0xEF,0xEF,0xB5,0xB5,0x7F,0x7F,0xAF,0xAF,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x28,0x30,0x30,0xF8,0xC8,0xF4,0x14,0xE8,0x28,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x28,0x30,0x30,0xF8,0xF8,0xF4,0xF4,0xE8,0xE8];
    var s2 = [0x57,0x55,0x2B,0x2B,0x05,0x05,0x0A,0x0A,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x57,0x57,0x2B,0x2B,0x05,0x05,0x0A,0x0A,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0xF4,0xF4,0xA8,0xA8,0x51,0x51,0x28,0x28,0x40,0x40,0x22,0x22,0x00,0x00,0x08,0x08,0xF4,0xF4,0xA8,0xA8,0x51,0x51,0x28,0x28,0x40,0x40,0x22,0x22,0x00,0x00,0x08,0x08,0x5F,0x5F,0x0E,0x0E,0x15,0x15,0x02,0x02,0x05,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x5F,0x5F,0x0E,0x0E,0x15,0x15,0x02,0x02,0x05,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xF0,0xAA,0xAA,0x50,0x50,0xA0,0xA0,0x04,0x04,0x20,0x20,0x11,0x11,0x00,0x00,0xF0,0xF0,0xAA,0xAA,0x50,0x50,0xA0,0xA0,0x04,0x04,0x20,0x20,0x11,0x11,0x00,0x00];
    rom.set(s1, 0xF8580);
    rom.set(s2, 0xF8780);
}

function randomizePlayerStart(rom, random, partyMembers)
{
    var choice = DATA_PLAYER_SPAWN_LOCATIONS[0]; //"Castle Britannia"
    if ($('#randomize_player_start').is(':checked'))
	{
        consoleLog("RANDOMIZING PLAYER START DESTINATIONS");
        choice = random.from(DATA_PLAYER_SPAWN_LOCATIONS);
    }
    
    setStartSpawnPosition(rom, choice.coordinates, partyMembers);

    //move the egg spawn from a selected moongate chunk in the case of spawning at a gate location to a field in Britain
    if(choice.spawnegg.length > 0)
    {
        rom.set(encode3BytePosition([0x4C,0x01,0x67,0x01]), choice.spawnegg[0]); //spawn eggs require Y first then X so this is Y, Super Chunk Y, X, Super Chunk X
    }

    if(choice.name != "Castle Britannia")
    {
        //move the gargoyle castle spawn to wherever you start
        rom.set([choice.coordinates[0], choice.coordinates[1]], 0x15EFA); //default 0x33, 0x01 - x coordinate for middle gargoyle
        rom.set([choice.coordinates[2]-2, choice.coordinates[3]], 0x15EFF); //default 0x5E, 0x01 - y coordinate for all gargoyles
        rom.set([choice.coordinates[0]-2, choice.coordinates[1]], 0x15F14); //default 0x32, 0x01 - x coordinate for left gargoyle
        rom.set([choice.coordinates[0]+2, choice.coordinates[1]], 0x15F1A); //default 0x34, 0x01 - x coordinate for right gargoyle
    }

    if(choice.raft.length > 0)
    {
        setRaftPosition(rom, 0x1672C, choice.raft[0], choice.raft[1], choice.raft[2], choice.raft[3]); //move swamp raft to this position
    }

    return choice.name;
}

function fixScheduleBugs(rom)
{
    rom.set([0xEA, 0xEA], 0x188EB); //this fixes the multi-day AI schedule bug where they are off by one when they attempt to loop and begin to read non-coordinate data as coordinates
    rom.set([0xFE, 0x9C, 0x02], 0x19507); //this fixes the Zoltan schedule bug where the first defined Zoltan spawn spot was in the void west of empath abbey
    //bonn
}

function adjustSchedules(rom)
{
    //either fix schedules for these NPCS or allow you to engage in their dialog stuff during any schedule point
    rom.set([0x0A], 0x18FE5); //big ben - lower time to leave house from noon to 10am
    rom.set([0x0C], 0x18EA6); //ephemerides - lower time when they awaken from 3pm to noon
    rom.set([0x57], 0x19587); //bonn - adjust behaviour to not be walking back and forth to the water edge (42 for wander - 57 for beggar)
}

function setDeathRespawnPosition(rom, inTileX, inSuperChunkX, inTileY, inSuperChunkY)
{
    rom.set([inTileX, inSuperChunkX], 0x627); //death respawn X
    rom.set([inTileY, inSuperChunkY], 0x62C); //death respawn Y
}

function setSpawnPositionAvatar(rom, inTileX, inSuperChunkX, inTileY, inSuperChunkY)
{
    rom.set([inTileX, inSuperChunkX], 0x8238); //avatar X
    rom.set([inTileY, inSuperChunkY], 0x823E); //avatar Y
    setDeathRespawnPosition(rom, inTileX, inSuperChunkX, inTileY, inSuperChunkY);
}

function setStartSpawnPosition(rom, coordinates, partyMembers)
{
    setSpawnPositionAvatar(rom, coordinates[0], coordinates[1], coordinates[2], coordinates[3]); //avatar

    //set spawn positions for when they are not in your party
    encode3BytePositionToAddress(rom, 0x18C41,   0xA3, 0x01, 0xDC, 0x02); //dupre not in party (spawn at Trinsic pub)
    encode3BytePositionToAddress(rom, 0x18C45,   0x51, 0x00, 0x03, 0x02); //shamino not in party (spawn at Skara Brae well)
    encode3BytePositionToAddress(rom, 0x18C49,   0xC3, 0x00, 0xEA, 0x00); //iolo not in party (spawn at Iolo Hut)

    rom.set([coordinates[0],coordinates[1]], 0x58E); //set the hardcoded Moon Orb 1U x position check to this x position

    setPartyMemberSpawnsAtNewGame(rom, coordinates, partyMembers);
}

function isPartyMemberFound(inName, inList)
{
    var found = false;

    for(var i = 0; i < inList.length; ++i)
    {
        if(inList[i].name == inName)
        {
            found = true;
            break;
        }
    }

    return found;
}

function setPartyMemberSpawnsAtNewGame(rom, coordinates, partyMembers)
{
    //8233 - 22 3F 88 03
    //var branchData = [0x22, 0xD0, 0xFD, 0x01];
    var branchData = [0x4C, 0xD0, 0xFD, 0xEA];
    rom.set(branchData, 0x8233);
    
    var codeData = [
                        0x22, 0x3F, 0x88, 0x03, //JSL to 03883F - this is the code we overwrote

                        0xC2, 0x21, //REP #$21
                        
                        0xA9, partyMembers[0].idoffset[0], partyMembers[0].idoffset[1], //LDA party member 0
                        0xAA, //TAX
                        0xA9, coordinates[0]-1, coordinates[1], //party member 1 X coordinates
                        0x9D, 0x00, 0x8E, //STA to 7E8E00 + x
                        0x9D, 0x00, 0x96, //STA to 7E9600 + x
                        0xA9, coordinates[2]+1, coordinates[3], //party member 1 Y coordinates
                        0x9D, 0x00, 0x90, //STA to 7E9000 + x
                        0x9D, 0x00, 0x98, //STA to 7E9800 + x

                        0xA9, partyMembers[1].idoffset[0], partyMembers[1].idoffset[1], //LDA party member 1
                        0xAA, //TAX
                        0xA9, coordinates[0]+1, coordinates[1], //party member 2 X coordinates
                        0x9D, 0x00, 0x8E, //STA to 7E8E00 + x
                        0x9D, 0x00, 0x96, //STA to 7E9600 + x
                        0xA9, coordinates[2]+1, coordinates[3], //party member 2 Y coordinates
                        0x9D, 0x00, 0x90, //STA to 7E9000 + x
                        0x9D, 0x00, 0x98, //STA to 7E9800 + x

                        0xA9, partyMembers[2].idoffset[0], partyMembers[2].idoffset[1], //LDA party member 2
                        0xAA, //TAX                        
                        0xA9, coordinates[0], coordinates[1], //party member 3 X coordinates
                        0x9D, 0x00, 0x8E, //STA to 7E8E00 + x
                        0x9D, 0x00, 0x96, //STA to 7E9600 + x
                        0xA9, coordinates[2]+2, coordinates[3], //party member 3 Y coordinates
                        0x9D, 0x00, 0x90, //STA to 7E9000 + x
                        0x9D, 0x00, 0x98, //STA to 7E9800 + x

                        0xE2, 0x20, //SEP #$20

                        0x4C,0x36,0x82, //JMP
                    ];
    rom.set(codeData, 0xFDD0);
}

function randomizePartyMembers(rom, random)
{
    var partyMembers = [];

    if ($('#select-starting-party').val() > 0)
	{
        adjustDupreLZWScript(rom);
        adjustShaminoLZWScript(rom);
        adjustIoloLZWScript(rom);
        adjustBehLemLZWScript(rom);
    
        if ($('#select-starting-party').val() == 1) //NONE
        {
            consoleLog("REMOVING PARTY MEMBERS");
            partyMembers.push(DATA_PARTY_MEMBERS[0]);
            partyMembers.push(DATA_PARTY_MEMBERS[0]);
            partyMembers.push(DATA_PARTY_MEMBERS[0]);
        }
        else if ($('#select-starting-party').val() == 2) //DEFAULT WITH REMOVE
        {
            partyMembers.push(DATA_PARTY_MEMBERS[1]);
            partyMembers.push(DATA_PARTY_MEMBERS[2]);
            partyMembers.push(DATA_PARTY_MEMBERS[3]);
        }
        else if ($('#select-starting-party').val() == 3) //RANDOM
        {
            consoleLog("RANDOMIZING PARTY MEMBERS");
            partyMembers = getRandomPartyMembers(random);
        }
	}
    else
    {
        partyMembers.push(DATA_PARTY_MEMBERS[1]);
        partyMembers.push(DATA_PARTY_MEMBERS[2]);
        partyMembers.push(DATA_PARTY_MEMBERS[3]);
    }

    setStartingPartyMemberStatusFlags(rom, partyMembers);

    return partyMembers;
}
function setStartingPartyMemberStatusFlags(rom, partyMembers)
{
    rom[0x8090] = countTotalPartyMembers(partyMembers);

    //809A - 8A C2 21 69 02 00 9D 29 01 E2 20 A9 80 9D 03 80 E8 E8 E0 08 00 90 E9
    //override function to set party member ids and in party status values
    var branchData = [   0x4C,0x80,0xFD,
        0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA,0xEA];

    var codeData = [
        0xA9, 0x80, //LDA #$80
        0x8D, 0x03, 0x80, //STA to 7E8003 - status of Avatar
        0xC2, 0x21, //REP #$21
        0xA9, 0x02, 0x00, //LDA 0002
        0xAA, //TAX
        0x8D, 0x29, 0x01, //STA to 7E0129 - inventory of Avatar
        0xE2, 0x20, //SEP #$20

        0xC2, 0x21, //REP #$21
        0xA9, partyMembers[0].idoffset[0], partyMembers[0].idoffset[1], //LDA party member 0
        0xAA, //TAX
        0x8D, 0x2B, 0x01, //STA to 7E012B - inventory of Party Member 1
        0xE2, 0x20, //SEP #$20
        0xA9, 0x80, //LDA #$80
        0xE8,
        0x9D, 0x00, 0x80, //STA to 7E8000 +x - status of Party Member 1

        0xC2, 0x21, //REP #$21
        0xA9, partyMembers[1].idoffset[0], partyMembers[1].idoffset[1], //LDA party member 0
        0xAA, //TAX
        0x8D, 0x2D, 0x01, //STA to 7E012D - inventory of Party Member 2
        0xE2, 0x20, //SEP #$20
        0xA9, 0x80, //LDA #$80
        0xE8,
        0x9D, 0x00, 0x80, //STA to 7E8000 +x- status of Party Member 2

        0xC2, 0x21, //REP #$21
        0xA9, partyMembers[2].idoffset[0], partyMembers[2].idoffset[1], //LDA party member 0
        0xAA, //TAX
        0x8D, 0x2F, 0x01, //STA to 7E012F - inventory of Party Member 3
        0xE2, 0x20, //SEP #$20
        0xA9, 0x80, //LDA #$80
        0xE8,
        0x9D, 0x00, 0x80, //STA to 7E8000 +x - status of Party Member 3

        0x4C, 0x9D, 0x80, //JMP back to the original function
    ];
    rom.set(branchData, 0x809A);
    rom.set(codeData, 0xFD80);
}

function getRandomPartyMembers(random)
{
    var members = [];
    var choices = [];

    for(var i = 1; i < DATA_PARTY_MEMBERS.length; ++i)
    {
        choices.push(i);
    }

    choices.shuffle(random);

    members.push(DATA_PARTY_MEMBERS[choices[0]]);
    members.push(DATA_PARTY_MEMBERS[choices[1]]);
    members.push(DATA_PARTY_MEMBERS[choices[2]]);

    return members;
}

function countTotalPartyMembers(inList)
{
    var count = 1;

    for(var i = 0; i < inList.length; ++i)
    {
        if(inList[i].name != "None")
        {
            count += 1;
        }
    }

    return count;
}

function setPlayerClass(rom, random, selected_player_class)
{
    //base stats in U6 PC pre-class selection is is 0xF 0xF 0xF (15 15 15)
    //PC selection results in 2 virtues taken once, 1 taken twice, 1 take three times, with the other 4 unaffected
    //  PC choices - honesty(int+3) compassion(dex+3) valor(str+3)
    //  PC choices - justice(int+1 dex+1) sacrifice(dex+1 str+1) honor (int+1 str+1)
    //  PC choices - spirituality(int+1 str+1 dex+1) humility(0)
    //SNES default stats 0x14 0x12 0x15 - 20 18 21
    consoleLog("RANDOMIZING PLAYER CLASS");
    if(selected_player_class == 1) //random
    {
        //chose random virtue 7 times(no virtue can be chosen more than 3 times)
        //  create virtue array with each virtue represented 3 times
        //  shuffle virtue array
        //  pop off the first 7 elements and increase the stats depending on the virtue chosen
        var class_virtues = ["compassion", "honesty", "honor", "humility", "justice", "sacrifice", "spirituality", "valor"];
        class_virtues.shuffle(random);
        setPlayerClassRandomStats(rom, class_virtues);
    }
    else if(selected_player_class == 2) //base stats only
    {
        setPlayerStats(rom, 15, 15, 15); //base stats only with no added virtue stat values
    }
    else if(selected_player_class == 3) //bard - compassion
    {
        var class_virtues = ["justice", "sacrifice", "spirituality"] //set virtues for this class
        class_virtues.shuffle(random); //randomize class virtues
        class_virtues.unshift("compassion"); //add core virtue first so that it is chosen 3 times
        setPlayerClassRandomStats(rom, class_virtues);
    }
    else if(selected_player_class == 4) //druid - justice
    {
        var class_virtues = ["compassion", "honesty", "honor", "sacrifice", "spirituality"] //set virtues for this class
        class_virtues.shuffle(random); //randomize class virtues
        class_virtues = class_virtues.slice(0,3);
        class_virtues.unshift("justice"); //add core virtue first so that it is chosen 3 times
        setPlayerClassRandomStats(rom, class_virtues);
    }
    else if(selected_player_class == 5) //fighter - valor
    {
        var class_virtues = ["honor", "sacrifice", "spirituality"] //set virtues for this class
        class_virtues.shuffle(random); //randomize class virtues
        class_virtues.unshift("valor"); //add core virtue first so that it is chosen 3 times
        setPlayerClassRandomStats(rom, class_virtues);
    }
    else if(selected_player_class == 6) //mage - honesty
    {
        var class_virtues = ["honor", "justice", "spirituality"];
        class_virtues.shuffle(random); //randomize class virtues
        class_virtues.unshift("honesty"); //add core virtue first so that it is chosen 3 times
        setPlayerClassRandomStats(rom, class_virtues);
    }
    else if(selected_player_class == 7) //paladin - honor
    {
        var class_virtues = ["honesty", "justice", "sacrifice", "spirituality", "valor"];
        class_virtues.shuffle(random); //randomize class virtues
        class_virtues = class_virtues.slice(0,3);
        class_virtues.unshift("honor"); //add core virtue first so that it is chosen 3 times
        setPlayerClassRandomStats(rom, class_virtues);
    }
    else if(selected_player_class == 8) //ranger - spirituality
    {
        var class_virtues = ["compassion", "honesty", "honor", "justice", "sacrifice", "valor"];
        class_virtues.shuffle(random); //randomize class virtues
        class_virtues = class_virtues.slice(0,3);
        class_virtues.unshift("spirituality"); //add core virtue first so that it is chosen 3 times
        setPlayerClassRandomStats(rom, class_virtues);
    }
    else if(selected_player_class == 9) //shephard - humility
    {
        var class_virtues = ["honor", "justice", "sacrifice"];
        class_virtues.shuffle(random); //randomize class virtues
        class_virtues.unshift("humility"); //add core virtue first so that it is chosen 3 times
        setPlayerClassRandomStats(rom, class_virtues);
    }
    else if(selected_player_class == 10) //tinker - sacrifice
    {
        var class_virtues = ["compassion", "honor", "justice", "spirituality", "valor"];
        class_virtues.shuffle(random); //randomize class virtues
        class_virtues = class_virtues.slice(0,3);
        class_virtues.unshift("sacrifice"); //add core virtue first so that it is chosen 3 times
        setPlayerClassRandomStats(rom, class_virtues);
    }
}

function setPlayerClassRandomStats(rom, virtue_list)
{
    var randStr = 15;
    var randDex = 15;
    var randInt = 15;

    for(var i = 0; i < 4; ++i)
    {
        var chosen_virtue = virtue_list.pop();
        var multiplier = i; //two virtues once, one virtue twice, one virtue three times
        if(i == 0)
        {
            multiplier = 1;
        }
        if(chosen_virtue == "compassion")           
        {
            randDex += 2 * multiplier;
        }
        else if(chosen_virtue == "honesty")
        {
            randInt += 2 * multiplier;
        }
        else if(chosen_virtue == "honor")
        {
            randStr += 1 * multiplier;
            randInt += 1 * multiplier;
        }
        else if(chosen_virtue == "justice")
        {
            randDex += 1 * multiplier;
            randInt += 1 * multiplier;
        }
        else if(chosen_virtue == "sacrifice")
        {
            randStr += 1 * multiplier;
            randDex += 1 * multiplier;
        }
        else if(chosen_virtue == "spirituality")
        {
            randStr += 1 * multiplier;
            randDex += 1 * multiplier;
            randInt += 1 * multiplier;
        }
        else if(chosen_virtue == "valor")
        {
            randStr += 2 * multiplier;
        }
    }

    setPlayerStats(rom, randStr, randDex, randInt);
}

function setPlayerStats(rom, str, dex, int)
{
    rom[0xEBF1] = str;    //player str 81EBF1 - EBF1 - 0x14 (20)
    rom[0xECAD] = dex;    //player dex 81ECAD - ECAD - 0x12 (18)
    rom[0xED69] = int;    //player int 81ED69 - ED6A - 0x15 (21)
}

function adjustDupreLZWScript(rom)
{
    var lzwData = decompressDataFromLZW(rom, 0x48000);
    
    //add option for Dupre to leave and join with dialog
    //3F 38 02 0C 10 A8 01 11 3F 2B 0D 00 12 00 0A 10 8D 00 11 3F 3A 0A
    var codeData = [    0x3F,0x38, 0x02,0x0C, //check if in party and branch
                        0x10, 0xA8,0x01 ,0x11,0x3F,0x2B,0x0D,0x00,0x12,0x00,0x0A, //dialog if in party - remove Dupre from party
                        0x10, 0x8D,0x00, 0x11,0x3F,0x3A,0x0A]; //dialog if not in party - add Dupre to party
    lzwData.set(codeData, 0x17);

    lzwData.set([0x38], 0x2FE); //point QUEST dialog pointer to the BYE dialog
}

function adjustShaminoLZWScript(rom)
{
    var lzwData = decompressDataFromLZW(rom, 0x48000);
    
    //add option for Shamino to leave and join with dialog
    var codeData = [    0x3F,0x38, 0x02,0x0C, //check if in party and branch
        0x10, 0xAB,0x01, 0x11,0x3F,0x2B,0x0D,0x00,0x12,0x00,0x0A, //dialog if in party - remove Shamino from party
        0x10, 0xC8,0x00, 0x11,0x3F,0x3A,0x0A]; //dialog if not in party - add Shamino to party
    lzwData.set(codeData, 0x32D);

    lzwData.set([0x11, 0x02], 0x347); //change HOME dialog function to DEEP FOREST dialog function
    lzwData.set([0x2E], 0x8A0); //point FOREST dialog pointer to the DEEP FOREST dialog
    writeTextToAddress(lzwData, 0x52A, 0x0F, "It is my home."); //change FOREST text to remove HOME text reference
}

function adjustIoloLZWScript(rom)
{
    var lzwData = decompressDataFromLZW(rom, 0x48000);

    //add option for Iolo to leave and join with dialog
    var codeData = [    0x3F,0x38, 0x02,0x0C, //check if in party and branch
        0x10, 0x3E,0x01, 0x11,0x3F,0x2B,0x0D,0x00,0x12,0x00,0x0A, //dialog if in party - remove Iolo from party
        0x10, 0xD9,0x03, 0x11,0x3F,0x3A,0x0A]; //dialog if not in party - add Iolo to party
    lzwData.set(codeData, 0x8E7);

    lzwData.set([0xE3, 0x02], 0x903); //change NO response to BARD dialog function to YES response to BARD dialog function
    lzwData.set([0x35], 0xFBC); //point BARD dialog pointer to the NO response to BARD dialog which allows unlocking GWENNO and the rest of the text
}

function adjustBehLemLZWScript(rom)
{
    var lzwData = decompressDataFromLZW(rom, 0x1D700);
    var codeData = [0x3F,0x2B,0x0D,0x00,0x12,0x00,0x00]; //add option for Beh Lem to leave
    lzwData.set(codeData, 0x15CC);
    lzwData.set([0x8C,0x01], 0x15D4);
}

//group - 0=none, 1=underground, 2=gargoyle, 3=norandom, 4=unlock
//type - 0=none, 1=shops, 2=quests, 3=partymember, 4=services, 5=important
//all values are -1 from the DATA_NPCS number values for each NPC 
var undergroundNPCs = [169,170,171]; //Dungeon Floor 4 (F4) NPCs (Captain John, Ybarra, Gorn)
var gargoyleLandsNPCs = [172,173,174,175,176,177,178,179,180,181,182,183,184,185,186];
var noRandomNPCs = [39,127,132,162,166,167,168];    //Penumbra, Sutek, Taynith, Mandrake, Daros, Pushme Pullyu, Phoenix
                                                    //Penumbra is the only overworld NPC that requires just dispel field
                                                    //Sutek is the only overworld NPC that requires dispel field and unlock
                                                    //Taynith and Mandrake have horrible schedules and often break on SNES
                                                    //Daros, Pushme Pullyu, and Phoenix are each alone on their respective dungeon floors and cannot be randomized
var unlockNPCs = [56,58]; //Boskin, Nicodemus - These two NPCs only require unlock to access

function shuffleNPCSchedules(rom, random)
{
    consoleLog("SHUFFLING NPC SCHEDULES");
    var noneList = [];
    var undergroundList = [];
    var gargoyleLandsList = [];
    var unlockList = [];
    var characterSpoilerList = [];
    for(var i = 1; i < 187; ++i)
    {
        if(noRandomNPCs.includes(i-1)==false)
        {
            var b1 = rom[0x18AC1 + (i*2)];
            var b2 = rom[0x18AC1 + (i*2) + 1];
            var listEntry = {"number": i, "byte1": b1, "byte2": b2};
            if(undergroundNPCs.includes(i-1))
            {
                undergroundList.push(listEntry);
            }
            else if(gargoyleLandsNPCs.includes(i-1))
            {
                gargoyleLandsList.push(listEntry);
            }
            else if(unlockNPCs.includes(i-1))
            {
                unlockList.push(listEntry);
            }
            else
            {
                noneList.push(listEntry);
            }
        }
    }
    
    noneList.shuffle(random);
    undergroundList.shuffle(random);
    gargoyleLandsList.shuffle(random);
    unlockList.shuffle(random);
    
    for(var i = 1; i < 187; ++i)
    {
        if(noRandomNPCs.includes(i-1)==false)
        {
            if(undergroundNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, undergroundList, characterSpoilerList);
            }
            else if(gargoyleLandsNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, gargoyleLandsList, characterSpoilerList);
            }
            else if(unlockNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, unlockList, characterSpoilerList);
            }
            else
            {
                npcShuffleListPop(rom, i, noneList, characterSpoilerList);
            }
        }
        else
        {
            var spoilerData = {"c1":getCharacterFromNumber(i), "c2":getCharacterFromNumber(i)};
            characterSpoilerList.push(spoilerData);
        }
    }
    return characterSpoilerList;
}

//group - 0=none, 1=underground, 2=gargoyle, 3=norandom, 4=unlock
//type - 0=none, 1=shops, 2=quests, 3=partymember, 4=services, 5=important
function shuffleNPCSchedulesSimilar(rom, random, potionShopAdded)
{
    consoleLog("SHUFFLING SIMILAR NPC SCHEDULES");
    var noneList = [];
    var subShopsList = [];
    var subQuestsList = [];
    var subPartyMemberList = [];
    var subServicesList = [];
    var subImportantList = [];
    var undergroundList = [];
    var gargoyleLandsList = [];
    var unlockList = [];
    var characterSpoilerList = [];
    for(var i = 1; i < 187; ++i)
    {
        if(noRandomNPCs.includes(i-1)==false)
        {
            var b1 = rom[0x18AC1 + (i*2)];
            var b2 = rom[0x18AC1 + (i*2) + 1];
            var listEntry = {"number": i, "byte1": b1, "byte2": b2};
            if(undergroundNPCs.includes(i-1))
            {
                undergroundList.push(listEntry);
            }
            else if(gargoyleLandsNPCs.includes(i-1))
            {
                gargoyleLandsList.push(listEntry);
            }
            else if(unlockNPCs.includes(i-1))
            {
                unlockList.push(listEntry);
            }
            else
            {
                //process the noneList
                var npc = getCharacterFromNumber(listEntry.number);
                if(npc.type == 1 || (potionShopAdded == true && listEntry.number == 48)) //special case for culham / senob
                {
                    subShopsList.push(listEntry);
                }
                else if(npc.type == 2)
                {
                    subQuestsList.push(listEntry);
                }
                else if(npc.type == 3)
                {
                    subPartyMemberList.push(listEntry);
                }
                else if(npc.type == 4)
                {
                    subServicesList.push(listEntry);
                }
                else if(npc.type == 5)
                {
                    subImportantList.push(listEntry);
                }
                else
                {
                    noneList.push(listEntry);
                }
            }
        }
    }
    
    noneList.shuffle(random);
    undergroundList.shuffle(random);
    gargoyleLandsList.shuffle(random);
    unlockList.shuffle(random);
    subShopsList.shuffle(random);
    subQuestsList.shuffle(random);
    subPartyMemberList.shuffle(random);
    subServicesList.shuffle(random);
    subImportantList.shuffle(random);
    
    for(var i = 1; i < 187; ++i)
    {
        if(noRandomNPCs.includes(i-1)==false)
        {
            if(undergroundNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, undergroundList, characterSpoilerList);
            }
            else if(gargoyleLandsNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, gargoyleLandsList, characterSpoilerList);
            }
            else if(unlockNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, unlockList, characterSpoilerList);
            }
            else
            {
                //process the noneList
                var npc = getCharacterFromNumber(i);
                if(npc.type == 1 || (potionShopAdded == true && i == 48)) //special case for culham / senob
                {
                    npcShuffleListPop(rom, i, subShopsList, characterSpoilerList);
                }
                else if(npc.type == 2)
                {
                    npcShuffleListPop(rom, i, subQuestsList, characterSpoilerList);
                }
                else if(npc.type == 3)
                {
                    npcShuffleListPop(rom, i, subPartyMemberList, characterSpoilerList);
                }
                else if(npc.type == 4)
                {
                    npcShuffleListPop(rom, i, subServicesList, characterSpoilerList);
                }
                else if(npc.type == 5)
                {
                    npcShuffleListPop(rom, i, subImportantList, characterSpoilerList);
                }
                else
                {
                    npcShuffleListPop(rom, i, noneList, characterSpoilerList);
                }
            }
        }
        else
        {
            var spoilerData = {"c1":getCharacterFromNumber(i), "c2":getCharacterFromNumber(i)};
            characterSpoilerList.push(spoilerData);
        }
    }
    return characterSpoilerList;
}

function shuffleNPCSchedulesPerArea(rom, random, potionShopAdded)
{
    consoleLog("SHUFFLING NPC SCHEDULES PER AREA");

    //define which NPCs belong to what areas
    //all values are -1 from the DATA_NPCS number values for each NPC 
    var britainNPCs = [3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,159,165];
    var bucsdenNPCs = [109,110,111,112,113,114,115,116,117,118,119];
    var coveNPCs = [120,121,122,123,124,125,126];
    var empathabbeyNPCs = [142,143,144,145,146,147,160,161];
    var jhelomNPCs = [41,42,43,44,45,46,48,49,50,51];
    var minocNPCs = [61,62,63,64,65,66,67,68,69,70,71,72];
    var moonglowNPCs = [31,32,33,34,35,36,37,38,40];
    var newmaginciaNPCs = [90,91,92,93,94,95,96];
    var overworldNPCs = [2,52,88,128,129,130,131,133,134,135,136,137,138,139,140,141];
    var pawsNPCs = [97,98,99,100,101,102,103,104,105,106,107,108];
    var serpentsholdNPCs = [148,149,150,151,152,153,154,155,156,157,158,164];
    var skarabraeNPCs = [1,80,81,82,83,84,85,86,87,89];
    var trinsicNPCs = [0,73,74,75,76,77,78,79];
    var yewNPCs = [53,54,55,57,58,59,60,163];

    if(potionShopAdded == true)
    {
        overworldNPCs.push(47);
    }
    else
    {
        jhelomNPCs.push(47);
    }

    var subBritainList = [];
    var subBucsDenList = [];
    var subCoveList = [];
    var subEmpathAbbeyList = [];
    var subJhelomList = [];
    var subMinocList = [];
    var subMoonglowList = [];
    var subNewMaginciaList = [];
    var subOverWorldList = [];
    var subPawsList = [];
    var subSerpentsHoldList = [];
    var subSkaraBraeList = [];
    var subTrinsicList = [];
    var subYewList = [];
    
    var noneList = [];
    var undergroundList = [];
    var gargoyleLandsList = [];
    var unlockList = [];
    var characterSpoilerList = [];
    for(var i = 1; i < 187; ++i)
    {
        if(noRandomNPCs.includes(i-1)==false)
        {
            var b1 = rom[0x18AC1 + (i*2)];
            var b2 = rom[0x18AC1 + (i*2) + 1];
            var listEntry = {"number": i, "byte1": b1, "byte2": b2};
            if(undergroundNPCs.includes(i-1))
            {
                undergroundList.push(listEntry);
            }
            else if(gargoyleLandsNPCs.includes(i-1))
            {
                gargoyleLandsList.push(listEntry);
            }
            else if(unlockNPCs.includes(i-1))
            {
                unlockList.push(listEntry);
            }
            else if(britainNPCs.includes(i-1))
            {
                subBritainList.push(listEntry);
            }
            else if(bucsdenNPCs.includes(i-1))
            {
                subBucsDenList.push(listEntry);
            }
            else if(coveNPCs.includes(i-1))
            {
                subCoveList.push(listEntry);
            }
            else if(empathabbeyNPCs.includes(i-1))
            {
                subEmpathAbbeyList.push(listEntry);
            }
            else if(jhelomNPCs.includes(i-1))
            {
                subJhelomList.push(listEntry);
            }
            else if(minocNPCs.includes(i-1))
            {
                subMinocList.push(listEntry);
            }
            else if(moonglowNPCs.includes(i-1))
            {
                subMoonglowList.push(listEntry);
            }
            else if(newmaginciaNPCs.includes(i-1))
            {
                subNewMaginciaList.push(listEntry);
            }
            else if(overworldNPCs.includes(i-1))
            {
                subOverWorldList.push(listEntry);
            }
            else if(pawsNPCs.includes(i-1))
            {
                subPawsList.push(listEntry);
            }
            else if(serpentsholdNPCs.includes(i-1))
            {
                subSerpentsHoldList.push(listEntry);
            }
            else if(skarabraeNPCs.includes(i-1))
            {
                subSkaraBraeList.push(listEntry);
            }
            else if(trinsicNPCs.includes(i-1))
            {
                subTrinsicList.push(listEntry);
            }
            else if(yewNPCs.includes(i-1))
            {
                subYewList.push(listEntry);
            }
            else
            {
                noneList.push(listEntry);
            }
        }
    }
    
    noneList.shuffle(random);
    undergroundList.shuffle(random);
    gargoyleLandsList.shuffle(random);
    unlockList.shuffle(random);

    subBritainList.shuffle(random);
    subBucsDenList.shuffle(random);
    subCoveList.shuffle(random);
    subEmpathAbbeyList.shuffle(random);
    subJhelomList.shuffle(random);
    subMinocList.shuffle(random);
    subMoonglowList.shuffle(random);
    subNewMaginciaList.shuffle(random);
    subOverWorldList.shuffle(random);
    subPawsList.shuffle(random);
    subSerpentsHoldList.shuffle(random);
    subSkaraBraeList.shuffle(random);
    subTrinsicList.shuffle(random);
    subYewList.shuffle(random);
    
    for(var i = 1; i < 187; ++i)
    {
        if(noRandomNPCs.includes(i-1)==false)
        {
            if(undergroundNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, undergroundList, characterSpoilerList);
            }
            else if(gargoyleLandsNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, gargoyleLandsList, characterSpoilerList);
            }
            else if(unlockNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, unlockList, characterSpoilerList);
            }
            else if(britainNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subBritainList, characterSpoilerList);
            }
            else if(bucsdenNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subBucsDenList, characterSpoilerList);
            }
            else if(coveNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subCoveList, characterSpoilerList);
            }
            else if(empathabbeyNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subEmpathAbbeyList, characterSpoilerList);
            }
            else if(jhelomNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subJhelomList, characterSpoilerList);
            }
            else if(minocNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subMinocList, characterSpoilerList);
            }
            else if(moonglowNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subMoonglowList, characterSpoilerList);
            }
            else if(newmaginciaNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subNewMaginciaList, characterSpoilerList);
            }
            else if(overworldNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subOverWorldList, characterSpoilerList);
            }
            else if(pawsNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subPawsList, characterSpoilerList);
            }
            else if(serpentsholdNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subSerpentsHoldList, characterSpoilerList);
            }
            else if(skarabraeNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subSkaraBraeList, characterSpoilerList);
            }
            else if(trinsicNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subTrinsicList, characterSpoilerList);
            }
            else if(yewNPCs.includes(i-1))
            {
                npcShuffleListPop(rom, i, subYewList, characterSpoilerList);
            }
            else
            {
                npcShuffleListPop(rom, i, noneList, characterSpoilerList);
            }
        }
        else
        {
            var spoilerData = {"c1":getCharacterFromNumber(i), "c2":getCharacterFromNumber(i)};
            characterSpoilerList.push(spoilerData);
        }
    }
    return characterSpoilerList;
}

function npcShuffleListPop(rom, i, inList, characterSpoilerList)
{
    var listEntry = inList.pop();
    rom[0x18AC1 + (i*2)] = listEntry.byte1;
    rom[0x18AC1 + (i*2) + 1] = listEntry.byte2;
    var spoilerData = {"c1":getCharacterFromNumber(listEntry.number), "c2":getCharacterFromNumber(i)};
    characterSpoilerList.push(spoilerData);
}

function getCharacterFromNumber(inNumber)
{
    for(var i=0; i < DATA_NPCS.length; ++i)
    {
        if(inNumber == DATA_NPCS[i].number)
        {
            return DATA_NPCS[i];
        }
    }
}

function getNPCName(inNumber)
{
    for(var i=0; i < DATA_NPCS.length; ++i)
    {
        if(inNumber == DATA_NPCS[i].number)
        {
            return DATA_NPCS[i].name;
        }
    }
}

function unrestrictNPCShuffleBehaviorChecks(rom)
{
    consoleLog("FIXING SHUFFLE BEHAVIOR CHECKS");
    var lzwData = decompressDataFromLZW(rom, 0x53900);
    lzwData.set([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00], 0x31FA); //was 12 20 0E 51 48 02 08 10 2C 02 11 0B 01 06- Michelle (basket)
    lzwData.set([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00], 0x3217); //was 12 20 0E 51 48 02 06 10 30 03 11 0B - Michelle (plans)
    lzwData.set([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00], 0x3985); //was 12 20 0E 51 48 02 06 10 82 01 11 0B - Aaron

    var lzwData = decompressDataFromLZW(rom, 0x49d00);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0xF8D); //was 12 20 0E 51 49 02 04 - Anya
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00], 0x2571); //was 12 20 0E 51 48 02 08 10 AB 01 11 0B 01 04 - Max (buy)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00], 0x2582); //was 12 20 0E 51 48 02 05 55 EE 01 04 0C - Max (sell)

    var lzwData = decompressDataFromLZW(rom, 0x4b900);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0xA); //was 12 20 0E 5E 49 02 06 10 F1 00 11 0A - Terri (eating)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x816); //was 12 20 0E 60 49 02 06 10 6A 01 11 0B - Kytyn (eating)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00], 0x1F50); //was 12 20 0E 4A 48 02 04 0C 17 00 10 95 01 11 0A - Ephemerides (telescope)

    var lzwData = decompressDataFromLZW(rom, 0x50000);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00], 0xEA6); //was 12 20 0E 5E 49 02 06 10 F1 00 11 0A - Nomman
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00], 0xEBB); //was 12 20 0E 5E 49 02 06 10 F1 00 11 0A - Nomman

    var lzwData = decompressDataFromLZW(rom, 0x51b00);
    lzwData.set([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00], 0x1A); //was 12 20 0E 51 48 02 04 0C 39 00 - Jerris
    lzwData.set([   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00], 0x383); //was 12 20 0E 49 49 12 20 0E 4E 49 4E 02 04 0C 3C 00 - Arvin (cooking)
    lzwData.set([   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00], 0xC10); //was 12 20 0E 50 49 02 04 0C - Big Ben (in house)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x1CE2); //was 12 20 0E 51 48 02 06 10 62 05 11 0B - Utomo
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x1D51); //was 12 20 0E 51 48 02 06 10 1F 06 11 0B - Utomo

    var lzwData = decompressDataFromLZW(rom, 0x55F80);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x29); //was 12 20 0E 51 48 02 06 10 ED 01 11 0B - Dale
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00], 0x412); //was 12 20 0E 51 48 02 08 10 C4 01 11 0B 01 04 - James
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00], 0x423); //was 12 20 0E 51 48 02 08 10 E6 01 11 0B 01 04 - James
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00], 0x2259); //was 12 20 0E 51 48 02 08 10 BE 01 11 0B 01 04 - Brandon
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00], 0x226A); //was 12 20 0E 51 48 02 08 10 DF 01 11 0B 01 04 - Brandon

    var lzwData = decompressDataFromLZW(rom, 0x5BA80);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x455); //was 12 20 0E 51 48 02 06 10 7E 01 11 0B - Mortude
    lzwData.set([   0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x756); //was 12 20 0E 51 48 02 04 0C 28 00 - Marissa
    //lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00], 0xC10); //was 12 20 0E 5E 49 02 04 0C 28 00 - Arbeth (morning before spindling)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00], 0xC57); //was 12 20 0E 5E 48 02 04 0C 8B 00 - Arbeth (eating)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x1355); //was 12 20 0E 51 48 02 06 10 9B 00 11 0A - Grison
    //lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00], 0x1FF0); //was 12 20 0E 51 48 02 07 3F 40 24 0C 28 00 - Hendle (do you want to buy more meat?)
    //lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00], 0x2017); //was 12 20 0E 51 49 02 07 10 46 01 11 01 05 - Hendle (do you want to buy more meat?)
    lzwData.set([   0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x2029); //was 12 20 0E 51 49 02 04 0C 5D 00 - Hendle

    var lzwData = decompressDataFromLZW(rom, 0x5D480);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00], 0x15); //was 12 20 0E 51 49 02 04 0C 22 00 10 B5 03 11 0A - Dr Cat

    var lzwData = decompressDataFromLZW(rom, 0x60000);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x136B); //was 10 C0 01 11 0B 01 08 - Charlotte (closed shop dialog)

    var lzwData = decompressDataFromLZW(rom, 0x68000);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x1A6B); //was 12 20 0E 51 48 02 06 10 07 03 11 0B - Stephanie (closed shop dialog)

    var lzwData = decompressDataFromLZW(rom, 0x69E80);
    lzwData.set([0x00,0x00,0x00,0x00,0x00], 0x5A);    //was 10 A9 02 11 0B - Gherick (magic shield)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0xBC);    //was 12 20 0E 51 48 02 06 10 FB 03 11 0B - Gherick (sell)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x12B);   //was 12 20 0E 51 48 02 06 10 2F 05 11 0B - Gherick (buy)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00], 0x1B4F);  //was 12 20 0E 51 48 02 08 10 96 02 11 0B - Loubet

    var lzwData = decompressDataFromLZW(rom, 0x6BB80);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x2B);    //was 12 20 0E 5E 49 02 06 10 E2 00 11 0B - Fyodor
    lzwData.set([   0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 
                    0x00,0x00], 0x795);    //was 12 20 0E 51 49 02 04 0C 28 00 - Efram
    lzwData.set([   0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 
                    0x00,0x00,0x00,0x00,0x00, 0x00], 0xB32);    //was 12 20 0E 51 49 02 04 0C 30 00 - Rufus
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x14E5); //was 12 20 0E 51 48 02 06 10 EE 02 11 0B - Tiberius (closed shop dialog)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x1EA4); //was 12 20 0E 61 48 02 06 10 0B 02 11 0B - Arty (buy dialog check)
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x227B); //was 12 20 0E 61 48 02 06 10 DF 01 11 0B - Lynn (buy dialog check)

    var lzwData = decompressDataFromLZW(rom, 0x6D480);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0xE78);  //was 12 20 0E 50 48 02 06 10 F7 04 11 0B - Gargoyle Healer
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x1698); //was 12 20 0E 51 48 02 06 10 ED 0A 11 0B - Gargoyle Smith
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x16DF); //was 12 20 0E 51 48 02 06 10 B3 0C 11 0B - Gargoyle Smith
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00], 0x24FA); //was 12 20 0E 50 49 02 07 10 5C 02 11 01 05 - Gargoyle Cook
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x2510); //was 12 20 0E 50 48 02 06 10 CB 02 11 0B - Gargoyle Cook

    var lzwData = decompressDataFromLZW(rom, 0x61A00);
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00], 0x31); //was 12 20 0E 51 48 02 08 10 FA 01 11 0B 01 04 - Enrik
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00], 0x42); //was 12 20 0E 51 48 02 08 10 1B 02 11 0B 01 04 - Enrik
    lzwData.set([0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00, 0x00,0x00], 0x174E); //was 12 20 0E 51 48 02 06 10 C4 01 11 0B - Ruydom
}

function simplifyNPCSchedules(rom, random)
{
    //TODO - Add simplified NPC schedules.
    //Goal - Simply more complex NPC schedules such that those NPCs can only appear in one of two places.
}

function addPotionShop(rom, random)
{
    consoleLog("ADDING POTION SHOP");
    //adjust culham schedule
    var newScheduleStart = [0x83, 0x4B, 0x50];
    var pos1 = encode3BytePosition([0x5C,0x03,0x6B,0x01]);
    var postPos1 = [0x8C, 0x50];
    var pos2 = encode3BytePosition([0x36,0x02,0x5B,0x01]);
    var postPos2 = [0xCD, 0x50];
    var pos3 = encode3BytePosition([0x3A,0x00,0xDF,0x01]);
    var newSchedule = newScheduleStart.concat(pos1.concat(postPos1.concat(pos2.concat(postPos2.concat(pos3)))));
    rom.set(newSchedule, 0x18F8F);

    rom.set([0x33, 0x45, 0x4E, 0x4F, 0x42, 0x00],0xC4D2) //adjust culham name
    rom[0xF089] = 0x2A; //adjust culham sprite (Skeleton)
    //rom[0xF18B] = 0x02; //adjust culham palette
    
    //add shop to world (112,49 - 0x831E0 - 0xDA,0x04) (113,49 - 0x831E1 - 0x9E,0x04)
    //setWorldChunkAtCoords(rom, 112,49, 0xF2,0x02);
    //setWorldChunkAtCoords(rom, 113,49, 0xF2,0x02);
    //add pickup items to shop (move items from healer)

    //adjust culham script
    var potionShopStartScript = [
        0x0B, 0x03, //pointer to last two bytes of the script
        0xF4, 0x02, //pointer to the end of the dialog section
        0x01, 0x03, //pointer to the bye dialog pointer
        0x10, 0xD2, 0x00, 0x11, //intro descripting text
        0x0E, 0x0D, 0x0D, 0x03, 0x0E, 0x01, 0x0D, 0x04, 0x5A, //play xylophone music (second byte - 0x0D)
        0x3F, 0x40, 0x27, 0x02, 0x07, //branch depending on if we have met the player before
        0x10, 0xE3, 0x00, 0x11, 0x01, 0x08, //intro dialog if we have met
        0x10, 0x0E, 0x01, 0x11, 0x3F, 0x40, 0x24, //intro dialog if we have not met
        0x07, //end the intro section and open the text selection menu
        0x10, 0x16, 0x01, 0x11, 0x0B, //name dialog
        0x10, 0x1F, 0x01, 0x11, 0x0B, //job dialog
        0x10, 0x4B, 0x01, 0x11, 0x0B, //potions dialog
        0x10, 0xB3, 0x01, 0x11, 0x0B, //rumors dialog
        0x10, 0xF5, 0x01, 0x11, 0x0A, //goodbye dialog
    ];

    var potionShopBuyScript = [
        0x0E, 0x00, 0x0D, 0x01, //start of buy section
        0x10, 0x07, 0x02, 0x11, //buy intro
        0x51, 0xB0, 0x00, //shop items address
        0x0D, 0x00, 0x0E, 0x00, 0x12, 0x00, //open the shop
        0x49, 0x02, 0x13, //branch
        0x12, 0x01, 0x0E, 0x00, //???
        0x49, 0x02, 0x07, //branch
        0x10, 0x1B, 0x02, 0x11, //buy exit without purchase
        0x01, 0x05, //???
        0x10, 0x3A, 0x02, 0x11, 0x0B, //buy exit with purchase
        0x12, 0x05, 0x12, 0x1E, //???
        0x44, 0x02, 0x07, //branch
        0x10, 0x88, 0x02, 0x11, //You do not have enough money
        0x55, 0xD2, //branch back to position
        0x10, 0x4E, 0x02, 0x11, //It is X Gold. Is it alright?
        0x08, 0x12, 0x23, 0x0E, 0x00,
        0x49, 0x02, 0x03, //branch
        0x55, 0xC4, //branch back to position
        0x10, 0x73, 0x02, 0x11, //Who will take it?
        0x0E, 0x00, 0x50, 0x0D, 0x09, 0x0E, 0x80, 0xFF, 0x12, 0x09, //party member purchases item
        0x49, 0x02, 0x03, //branch
        0x55, 0xB1, //branch back to position
        0x5E, 0x12, 0x06, 0x0E, 0x00,
        0x48, 0x02, 0x07, //branch
        0x10, 0xA7, 0x02, 0x11, //You can't carry any more
        0x55, 0xA3, //branch back to position
        0x12, 0x1E, 0x12, 0x05, 0x4B, 0x0D, 0x1E, 0x0E, 0x01, 0x0D, 0x01,
        0x10, 0xC4, 0x02, 0x11, //Thank you very much
        0x55, 0x96, //branch back to position
    ];

    var potionShopItemsScript = [
        //0E potion 0E price
        0x06, //number of items in shop
        0x0E, 0x80, 0x94, 0x0E, 0x20, //white 100
        0x0E, 0x80, 0x8E, 0x0E, 0x30, //blue 100
        0x0E, 0x80, 0x8D, 0x0E, 0x38, //red 100
        0x0E, 0x80, 0x8F, 0x0E, 0x38, //yellow 110
        0x0E, 0x80, 0x92, 0x0E, 0x80, 0x70, //purple 120
        0x0E, 0x80, 0x93, 0x0E, 0x80, 0x7F, //black 150
    ];

    //5F=space, 0E=period, 0C=comma, 1F=question mark, 02=quotes, capitals are lowercase-20
    //FE XX - in text keyword where XX is distance from this point the keyword
    //04 XX - XX is the text
    var potionShopTextScript = [
        0x0A,
        0x21, 0x5F, 0x42, 0x4F, 0x4E, 0x45, 0x59, 0x5F, 0x46, 0x49, 0x47, 0x55, 0x52, 0x45, 0x0E, 0xF3, 0x00, //description - A boney figure.
        0x02, 0x28, 0x4D, 0x4D, 0x4D, 0x0E, 0x5F, 0x39, 0x4F, 0x55, 0x5F, 0x41, 0x52, 0x45, 0x5F, 0x53, 0x54, 0x49, 0x4C, 0x4C, 0x5F, 0x41, 0x4C, 0x49, 0x56, 0x45, 0x1F, 0x5F, 0x37, 0x45, 0x4C, 0x43, 0x4F, 0x4D, 0x45, 0x5F, 0x42, 0x41, 0x43, 0x4B, 0x0E, 0x02, 0x00, //intro second - "Hmmm. You still are alive? Welcome back."
        0x02, 0x28, 0x4D, 0x4D, 0x4D, 0x0E, 0x02, 0x00, //intro first - "Hmmm."
        0x02, 0x33, 0x45, 0x4E, 0x4F, 0x42, 0x0E, 0x02, 0x00, //name - "Senob."
        0x02, 0x29, 0x5F, 0x53, 0x45, 0x4C, 0x4C, 0x5F, 0x4F, 0x4E, 0x4C, 0x59, 0x5F, 0x54, 0x48, 0x45, 0x5F, 0x53, 0x54, 0x52, 0x4F, 0x4E, 0x47, 0x45, 0x53, 0x54, 0x5F, 0x4F, 0x46, 0x5F, 0xFE, 0x20, 0x0E, 0x02, 0x00, //job - "I sell only the strongest of potions."
        0x07, 0x50, 0x4F, 0x54, 0x49, 0x4F, 0x4E, 0x53, 0x00, //potions keyword
        0x02, 0x2D, 0x59, 0x5F, 0x53, 0x54, 0x52, 0x4F, 0x4E, 0x47, 0x45, 0x53, 0x54, 0x5F, 0x50, 0x4F, 0x54, 0x49, 0x4F, 0x4E, 0x53, 0x5F, 0x57, 0x49, 0x4C, 0x4C, 0x5F, 0x4B, 0x49, 0x4C, 0x4C, 0x5F, 0x41, 0x5F, 0x44, 0x52, 0x41, 0x47, 0x4F, 0x4E, 0x0C, 0x5F, 0x4C, 0x45, 0x54, 0x5F, 0x41, 0x4C, 0x4F, 0x4E, 0x45, 0x5F, 0x41, 0x5F, 0x4D, 0x41, 0x4E, 0x0E, 0x5F, 0x30, 0x45, 0x52, 0x48, 0x41, 0x50, 0x53, 0x5F, 0x59, 0x4F, 0x55, 0x5F, 0x57, 0x4F, 0x55, 0x4C, 0x44, 0x5F, 0x4C, 0x49, 0x4B, 0x45, 0x5F, 0x41, 0x5F, 0xFE, 0x21, 0x5F, 0x49, 0x4E, 0x53, 0x54, 0x45, 0x41, 0x44, 0x1F, 0x02, 0x00, //potions - "My strongest potions will kill a dragon, let alone a man. Perhaps you would like a rumor instead?"
        0x05, 0x52, 0x55, 0x4D, 0x4F, 0x52, 0x00, //rumor keyword
        0x02, 0x29, 0x5F, 0x48, 0x45, 0x41, 0x52, 0x5F, 0x54, 0x48, 0x45, 0x52, 0x45, 0x5F, 0x41, 0x52, 0x45, 0x5F, 0x4D, 0x41, 0x4E, 0x59, 0x5F, 0x53, 0x45, 0x43, 0x52, 0x45, 0x54, 0x5F, 0x57, 0x41, 0x4C, 0x4C, 0x53, 0x5F, 0x48, 0x49, 0x44, 0x44, 0x45, 0x4E, 0x5F, 0x54, 0x48, 0x52, 0x4F, 0x55, 0x47, 0x48, 0x4F, 0x55, 0x54, 0x5F, 0x54, 0x48, 0x45, 0x5F, 0x57, 0x4F, 0x52, 0x4C, 0x44, 0x0E, 0x02, 0x00, //rumor - "I hear there are many secret walls hidden throughout the world."
        0x02, 0x34, 0x52, 0x59, 0x5F, 0x4E, 0x4F, 0x54, 0x5F, 0x54, 0x4F, 0x5F, 0x44, 0x49, 0x45, 0x0E, 0x02, 0x00, //goodbye - "Try not to die."
        0x02, 0x37, 0x48, 0x41, 0x54, 0x5F, 0x57, 0x49, 0x4C, 0x4C, 0x5F, 0x49, 0x54, 0x5F, 0x42, 0x45, 0x1F, 0x02, 0xF0, 0x00, //buy intro - "What will it be?"
        0x02, 0x39, 0x4F, 0x55, 0x5F, 0x43, 0x41, 0x4E, 0x07, 0x54, 0x5F, 0x48, 0x41, 0x4E, 0x44, 0x4C, 0x45, 0x5F, 0x4D, 0x59, 0x5F, 0x50, 0x4F, 0x54, 0x49, 0x4F, 0x4E, 0x53, 0x0E, 0x02, 0x00, //buy exit without purchase - "You can't handle my potions."
        0x02, 0x35, 0x53, 0x45, 0x5F, 0x54, 0x48, 0x45, 0x53, 0x45, 0x5F, 0x57, 0x49, 0x53, 0x45, 0x4C, 0x59, 0x0E, 0x02, 0x00, //buy exit with purchase - "Use these wisely."
        0x02, 0x34, 0x48, 0x49, 0x53, 0x5F, 0x49, 0x53, 0x5F, 0xFC, 0x06, 0x5F, 0x27, 0x4F, 0x4C, 0x44, 0x0E, 0xF0, 0x21, 0x52, 0x45, 0x5F, 0x59, 0x4F, 0x55, 0x5F, 0x43, 0x45, 0x52, 0x54, 0x41, 0x49, 0x4E, 0x1F, 0x02, 0xF0, 0x00, //buy cost - "This is X Gold. Are you certain?"
        0x02, 0x37, 0x48, 0x4F, 0x5F, 0x57, 0x49, 0x4C, 0x4C, 0x5F, 0x54, 0x41, 0x4B, 0x45, 0x5F, 0x49, 0x54, 0x1F, 0x02, 0xF0, 0x00, //buy who -  "Who will take it?"
        0x02, 0x39, 0x4F, 0x55, 0x5F, 0x44, 0x4F, 0x4E, 0x07, 0x54, 0x5F, 0x48, 0x41, 0x56, 0x45, 0x5F, 0x45, 0x4E, 0x4F, 0x55, 0x47, 0x48, 0x5F, 0x27, 0x4F, 0x4C, 0x44, 0x0E, 0x02, 0xF0, 0x00, //buy not enough - "You do not have enough Gold"
        0x02, 0x39, 0x4F, 0x55, 0x5F, 0x43, 0x41, 0x4E, 0x07, 0x54, 0x5F, 0x43, 0x41, 0x52, 0x52, 0x59, 0x5F, 0x41, 0x4E, 0x59, 0x5F, 0x4D, 0x4F, 0x52, 0x45, 0x0E, 0x02, 0xF0, 0x00, //buy encumbered - "You can't carry any more."
        0x02, 0x29, 0x53, 0x5F, 0x54, 0x48, 0x41, 0x54, 0x5F, 0x41, 0x4C, 0x4C, 0x1F, 0x02, 0xF0, 0x00, //buy finished - "Is that all?"
    ];

    var potionShopFillerScript = [0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x00];

    var potionShopEndScript = [
        0x04, //number of entries
        0x00,0x24,0x00, //name dialog function pointer
        0x01,0x29,0x00, //job dialog function pointer
        0x03,0x3D,0x00, //buy dialog function pointer
        0x02,0x38,0x00, //bye dialog function pointer
        0x02, //number of extra keywords
        0x2E,0x00, //potions dialog function pointer
        0x42,0x01, //potions dialog pointer
        0x33,0x00, //rumor dialog function pointer
        0xAC,0x01, //rumor dialog pointer
    ];

    var potionShopFullScript = potionShopStartScript.concat(potionShopBuyScript.concat(potionShopItemsScript.concat(potionShopTextScript.concat(potionShopFillerScript.concat(potionShopEndScript)))));
    if(potionShopFullScript.length != 780)
    {
        consoleLog("ERROR - Potion shopkeep script length is " + potionShopFullScript.length + " and needs to be 780");
    }
    else
    {
        var lzwData = decompressDataFromLZW(rom, 0x50000);
        for(var i=0; i < 0x30D; ++i)
        {
            lzwData.set([0x00], 0x2607+i);
        }
        lzwData.set(potionShopFullScript, 0x2607);
    }
}
